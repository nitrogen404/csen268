rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    /* USERS */
    match /users/{userId} {
      allow read: if request.auth != null;

      allow update, create: if request.auth != null &&
        request.auth.uid == userId;
      
      // Allow coin transactions (for earning/spending)
      // Users can update their own coins via CurrencyService
      // Note: Coin updates are validated in the app code (CurrencyService)

      match /activity/{activityId} {
        allow read, create: if request.auth != null &&
          request.auth.uid == userId;
      }

      // Friend requests sent TO this user
      match /friendRequests/{requestId} {
        allow read: if request.auth != null &&
          request.auth.uid == userId;
        allow create: if request.auth != null;
        allow update: if request.auth != null &&
          request.auth.uid == userId;
      }

      // Friends list
      match /friends/{friendId} {
        allow read: if request.auth != null &&
          request.auth.uid == userId;
        // User themselves OR the friend (when creating reciprocal entry)
        allow create, update, delete: if request.auth != null &&
          (request.auth.uid == userId || request.auth.uid == friendId);
      }

      // Chain invites sent TO this user
      match /chainInvites/{inviteId} {
        allow read: if request.auth != null &&
          request.auth.uid == userId;
        allow create: if request.auth != null;
        allow update: if request.auth != null &&
          request.auth.uid == userId;
      }

      // Group reminders - allows any authenticated user to create reminders for others
      // (when someone completes a check-in and wants to remind group members)
      match /groupReminders/{reminderId} {
        // Allow any authenticated user to create reminders for other users
        // This is needed when User A completes check-in and wants to remind User B
        allow create: if request.auth != null
                      && request.resource.data.keys().hasAll(['chainId', 'chainTitle', 'message', 'type', 'createdAt', 'read', 'sent'])
                      && request.resource.data.type == 'group_checkin_reminder'
                      && request.resource.data.read == false
                      && request.resource.data.sent == false;
        
        // Users can only read their own reminders
        allow read: if request.auth != null &&
          request.auth.uid == userId;
        
        // Users can update their own reminders (e.g., mark as read)
        allow update: if request.auth != null &&
          request.auth.uid == userId;
        
        // Cloud Functions can update (mark as sent) - handled via admin SDK
      }

      // Coin transactions history (optional, for tracking)
      match /coinTransactions/{transactionId} {
        // Users can read their own transaction history
        allow read: if request.auth != null &&
          request.auth.uid == userId;
        
        // Users can create their own transaction records
        allow create: if request.auth != null &&
          request.auth.uid == userId;
      }
    }

    /* CHAINS */
    match /chains/{chainId} {
      allow list, get, create: if request.auth != null;

      allow update: if request.auth != null &&
        (
          exists(/databases/$(database)/documents/chains/$(chainId)/members/$(request.auth.uid))
          ||
          request.resource.data.memberCount > resource.data.memberCount
          ||
          // Allow owner to update theme
          (get(/databases/$(database)/documents/chains/$(chainId)).data.ownerId == request.auth.uid
           && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['theme']))
        );

      allow delete: if request.auth != null &&
        get(/databases/$(database)/documents/chains/$(chainId)).data.ownerId == request.auth.uid;

      match /members/{memberId} {
        allow read: if request.auth != null &&
          (
            memberId == request.auth.uid ||
            exists(/databases/$(database)/documents/chains/$(chainId)/members/$(request.auth.uid))
          );

        allow create: if request.auth != null &&
          memberId == request.auth.uid;

        allow update: if request.auth != null &&
          (
            memberId == request.auth.uid ||
            get(/databases/$(database)/documents/chains/$(chainId)).data.ownerId == request.auth.uid
          );

        allow delete: if request.auth != null &&
          get(/databases/$(database)/documents/chains/$(chainId)).data.ownerId == request.auth.uid;
      }

      // UPDATED: allow chain owner to delete messages (for full chain deletion)
      match /messages/{messageId} {
        // Everyone in the chain can read/create messages
        allow read, create: if request.auth != null &&
          exists(/databases/$(database)/documents/chains/$(chainId)/members/$(request.auth.uid));

        // Owner can delete messages when deleting the chain
        allow delete: if request.auth != null &&
          get(/databases/$(database)/documents/chains/$(chainId)).data.ownerId == request.auth.uid;

        // Still block updates
        allow update: if false;
      }
    }

    /* GLOBAL MEMBERS READ SUPPORT */
    match /{path=**}/members/{memberId} {
      allow read: if request.auth != null &&
        resource.data.userId == request.auth.uid;
    }
  }
}

